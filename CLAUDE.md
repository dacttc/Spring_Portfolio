# Project Overview

Cities: Skylines 스타일의 웹 기반 도시 운영 방치형 게임. 플레이어는 시장이 되어 공공시설을 건설하고, 시민들이 자동으로 정착하여 세금을 납부하는 시스템.

## Game Concept

- **장르**: 웹 기반 방치형 도시 운영 시뮬레이션
- **목표**: 하루 5-10분 플레이로 도시 성장
- **핵심**: 매일 접속하여 세금 수집 + 이벤트 대응 + 건설

---

## Game Systems

### 1. 자원 시스템

| 자원 | 설명 |
|------|------|
| 💰 자금 | 세금 수입, 건물 건설 비용 |
| ⚡ 전력 | 발전소에서 생산, 모든 건물에 필요 |
| 😊 행복도 | 시민 만족도, 공원/문화시설로 증가 |
| 👥 인구 | 도시 규모 지표 |

### 2. 건물 종류

#### 공공시설 (플레이어가 건설)
| 건물 | 비용 | 효과 |
|------|------|------|
| 발전소 | ₩5,000 | 전력 공급 (범위 10칸) |
| 경찰서 | ₩3,000 | 치안 유지 (범위 8칸) |
| 소방서 | ₩3,000 | 화재 예방 (범위 8칸) |
| 공원 | ₩1,000 | 행복도 +10 (범위 5칸) |
| 학교 | ₩4,000 | 중류층 전환율 증가 |
| 병원 | ₩6,000 | 상류층 전환율 증가 |

#### 시민 건물 (자동 생성)
| 구역 | 조건 | 세금 |
|------|------|------|
| 주거 (하류) | 전기+도로 | ₩100/시간 |
| 주거 (중류) | +치안+학교 | ₩300/시간 |
| 주거 (상류) | +병원+공원 | ₩800/시간 |
| 상업 | 인구 100+ | ₩200/시간 |
| 공업 | 인구 50+ | ₩150/시간 |

### 3. 시간 시스템

```
오프라인 진행:
├── 세금 자동 적립 (최대 24시간)
├── 시민 자동 정착/업그레이드
├── 24시간 초과 → 창고 가득 참 (수집 필요)
└── 48시간 초과 → 행복도 하락 시작
```

### 4. 일일 행동력 (AP)

| 행동 | AP 비용 |
|------|---------|
| 건물 건설 | 2 AP |
| 구역 지정 | 1 AP |
| 정책 변경 | 3 AP |
| 이벤트 대응 | 1 AP |
| **일일 총 AP** | **10 AP** |

### 5. 이벤트 시스템

| 이벤트 | 발생 조건 | 방치 시 | 대응 시 |
|--------|----------|---------|---------|
| 화재 | 소방서 부족 | 건물 파괴 | 신뢰도 +5 |
| 범죄 | 경찰서 부족 | 행복도 -10 | 치안 +10 |
| 정전 | 전력 부족 | 세금 -50% | 정상화 |
| 축제 요청 | 랜덤 | 없음 | 행복도 +20 |
| 기업 유치 | 인구 1000+ | 없음 | 상업 +3 |

### 6. 성장 마일스톤

| 인구 | 해금 |
|------|------|
| 100 | 상업 구역 |
| 500 | 공업 구역 |
| 1,000 | 학교, 병원 |
| 5,000 | 대형 발전소 |
| 10,000 | 지하철 |
| 50,000 | 공항 |
| 100,000 | 랜드마크 |

### 7. 연속 출석 보상

| 일차 | 보상 |
|------|------|
| Day 1 | ₩1,000 |
| Day 3 | ₩5,000 |
| Day 7 | 특별 건물 |
| Day 14 | ₩20,000 |
| Day 30 | 프리미엄 건물 |

---

## Tech Stack

| 분류 | 기술 |
|------|------|
| Backend | Spring Boot 3.5.9, Java 17 |
| Database | MySQL (AWS RDS) |
| ORM | Spring Data JPA + Hibernate |
| Security | Spring Security 6 |
| Template | Thymeleaf |
| Email | AWS SES SMTP |
| Build | Gradle |
| 3D Graphics | Three.js v0.160.0 |

---

## 3D Assets

### 필요한 에셋 목록

| 카테고리 | 에셋 | 용도 |
|----------|------|------|
| **도로** | road_straight, road_corner, road_t, road_cross | 기본 도로 시스템 |
| **공공시설** | power_plant, police_station, fire_station | 공공 건물 |
| **편의시설** | park, school, hospital | 서비스 건물 |
| **주거** | house_low, house_mid, house_high | 주거 구역 (자동 생성) |
| **상업/공업** | shop, factory | 상업/공업 구역 |
| **대형시설** | subway_station, airport, landmark | 해금 건물 |
| **차량** | car_basic (로우폴리) | 장식용 교통 표현 |

### 에셋 소스 (무료/유료)

| 소스 | URL | 특징 |
|------|-----|------|
| Kenney Assets | kenney.nl | 무료, 로우폴리, 게임용 |
| Poly Pizza | poly.pizza | 무료, 로우폴리 |
| Sketchfab | sketchfab.com | 무료/유료, 다양한 스타일 |
| Quaternius | quaternius.com | 무료, 로우폴리 |
| Unity Asset Store | assetstore.unity.com | 유료, 고퀄리티 |
| TurboSquid | turbosquid.com | 유료, 전문가용 |

### 에셋 요구사항

- **포맷**: GLTF/GLB (Three.js 호환)
- **폴리곤**: 로우폴리 권장 (1000-5000 faces)
- **스타일**: 일관된 카툰/로우폴리 스타일
- **크기**: 1 타일 = 1 유닛 기준으로 스케일 조정

---

## Project Structure

```
src/main/java/com/example/portfolio/
├── config/          # SecurityConfig
├── controller/      # REST API + View Controllers
├── domain/          # JPA Entities (User, CityMap, EmailVerificationToken)
├── dto/             # Request/Response DTOs
├── repository/      # JPA Repositories
├── service/         # Business Logic
└── security/        # CustomUserDetailsService

src/main/resources/
├── templates/       # Thymeleaf HTML (city.html, home.html, etc.)
└── static/models/   # 3D GLTF road models
```

## Key Features

- `/{username}` - 유저별 도시 맵 페이지
- `/api/map/{username}` - 맵 데이터 REST API (GET/PUT)
- 48x48 그리드 도로 건설 시스템
- 소유자 편집 / 방문자 보기 전용

## Rules

### DB 사용량 최소화
- 자동저장 사용 금지 - 명시적 저장 버튼 클릭 시에만 저장
- 변경사항(`isDirty`) 있을 때만 API 호출
- 불필요한 조회/저장 쿼리 최소화

### 도시 변경사항 보존
- 모든 도시 변경사항은 반드시 DB에 저장되어야 함
- 저장되지 않은 변경사항 있을 시 페이지 이탈 경고 표시
- 그리드 데이터는 JSON 형태로 LONGTEXT 컬럼에 저장

### 코드 컨벤션
- Entity: Lombok + JPA (@Entity, @Getter, @Setter, @Builder)
- Service: @Service, @Transactional, @RequiredArgsConstructor
- Controller: @Controller (템플릿) / @RestController (API)
- DTO: Jakarta Validation 사용 (@NotNull, @Min, @Email 등)

### Thymeleaf 템플릿 주의사항

**⚠️ JavaScript에서 `[[` 패턴 사용 금지 (주석 포함)**

Thymeleaf는 `[[...]]`를 인라인 표현식으로 해석하므로, JavaScript 코드 및 **주석**에서도 이 패턴 사용 시 오류 발생:

```javascript
// ❌ Bad: Thymeleaf가 [[-1을 표현식으로 해석하여 오류 발생
const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];

// ✅ Good: push()로 분리하여 [[ 패턴 회피
const directions = [];
directions.push([-1, 0], [1, 0], [0, -1], [0, 1]);

// ✅ Good: Array.of() 사용
const directions = Array.of([-1, 0], [1, 0], [0, -1], [0, 1]);
```

**오류 메시지 예시:**
```
TemplateProcessingException: Could not parse as expression: "-1, 0], [1, 0]..."
```

**⚠️ CSRF 토큰 접근 시 `?.` 연산자 사용 금지**

Thymeleaf에서 `?.` (safe navigation) 연산자는 SpEL 오류 발생:

```html
<!-- ❌ Bad: SpEL 평가 오류 발생 -->
<input type="hidden" name="_csrf" th:value="${_csrf?.token}" />

<!-- ✅ Good: th:if로 null 체크 후 접근 -->
<input type="hidden" name="_csrf" th:if="${_csrf}" th:value="${_csrf.token}" />
```

**참고:** `/api/**` 엔드포인트는 SecurityConfig에서 CSRF가 비활성화되어 있으므로 API 호출 시 CSRF 토큰 불필요.

### 성능 최적화 (CPU/RAM/GPU)
모든 구현은 성능 최적화를 고려해야 함:

#### CPU 최적화
- 불필요한 반복문 최소화, O(n²) 이상의 알고리즘 지양
- 무거운 계산은 캐싱 활용 (결과 재사용)
- `requestAnimationFrame` 내 연산 최소화
- 이벤트 핸들러에 throttle/debounce 적용

#### RAM 최적화
- 대용량 배열/객체는 필요 시에만 생성, 사용 후 참조 해제
- Three.js geometry/material/texture는 사용 후 `.dispose()` 호출
- 오브젝트 풀링 패턴 활용 (차량, 파티클 등 자주 생성/삭제되는 객체)
- 메모리 누수 방지 (이벤트 리스너 정리, 타이머 클리어)

#### GPU 최적화
- Three.js `InstancedMesh` 사용 (동일 geometry 대량 렌더링)
- LOD (Level of Detail) 적용 - 거리에 따른 디테일 조절
- 불필요한 `material.needsUpdate`, `geometry.attributes.*.needsUpdate` 호출 지양
- 셰이더 연산 최소화, 텍스처 해상도 적절히 조절
- Frustum Culling 활용 (카메라 밖 오브젝트 렌더링 스킵)
- Draw call 최소화 (material/geometry 병합)

#### 일반 원칙
```javascript
// ❌ Bad: 매 프레임 새 객체 생성
function animate() {
    const tempVec = new THREE.Vector3();  // 매번 할당
}

// ✅ Good: 재사용 가능한 객체 미리 생성
const tempVec = new THREE.Vector3();  // 한 번만 생성
function animate() {
    tempVec.set(0, 0, 0);  // 재사용
}
```

---

## Security (보안)

### 핵심 원칙: 클라이언트를 신뢰하지 않음

모든 게임 로직과 데이터 검증은 서버에서 수행. 클라이언트에서 전송된 값(돈, 통계 등)은 참고용으로만 사용하고, 서버에서 재계산.

### 구현된 보안 기능

#### 1. 서버 측 검증 (GameSecurityService)
```java
// 모든 수치는 서버에서 계산
Long serverCalculatedMoney = calculateServerMoney(cityMap, request.getGrid());
cityMap.updateMap(gridJson, serverCalculatedMoney);  // 클라이언트 money 무시
```

#### 2. Rate Limiting
| 설정 | 값 |
|------|-----|
| 분당 최대 요청 | 30회 |
| 윈도우 시간 | 60초 |

```java
if (!gameSecurityService.checkRateLimit(username)) {
    throw new SecurityException("요청이 너무 많습니다");
}
```

#### 3. 데이터 무결성 검증
- **잠긴 셀 변경 방지**: 외곽 도로(LOCKED_ROAD) 수정 불가
- **비용 검증**: 현재 자금 < 건설 비용이면 거부
- **대량 변경 감지**: 한 번에 100칸 이상 변경 불가
- **비정상 돈 증가 감지**: 예상 수입 초과 시 경고

#### 4. 이상 행동 감지
```java
// 비정상적으로 빠른 진행 감지
if (playTime.toHours() < 1 && population > 1000) {
    log.warn("Anomalous progress detected");
}

// 비정상적인 자금 감지
if (money > maxPossibleMoney * 2) {
    log.warn("Anomalous money detected");
}
```

#### 5. Checksum 검증 (선택적)
```java
String checksum = gameSecurityService.generateChecksum(username, grid, money);
boolean valid = gameSecurityService.verifyChecksum(username, grid, money, checksum);
```

### 클라이언트 보안 (참고용)

클라이언트 측 보안은 UX 개선용이며, 실제 보안은 서버에서 담당:

```javascript
// 콘솔 조작 방지 (개발자 도구 감지)
// 주의: 우회 가능하므로 서버 검증 필수
Object.freeze(economy);  // 객체 동결
Object.freeze(cityStats);
```

### 보안 로그

모든 보안 관련 이벤트는 로그로 기록:
```
WARN - Rate limit exceeded for user: username
WARN - Suspicious money increase detected: 5000 -> 1000000
WARN - Attempt to modify locked cell at (0, 0)
WARN 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 username
```

### 금지된 행위

| 행위 | 감지 방법 | 대응 |
|------|----------|------|
| 콘솔로 돈 조작 | 서버 재계산 | 무시됨 |
| 잠긴 영역 수정 | 그리드 검증 | 거부 |
| API 스팸 | Rate Limiting | 차단 |
| 비정상 진행 | 이상 감지 | 로그/차단 |

---

## UI/UX 규칙

### 반응형 UI 스케일링 (필수)

**모든 새로운 UI 요소와 텍스트는 반드시 화면 크기 비율에 맞게 구현해야 함.**

#### CSS 변수 사용 규칙

| 용도 | 변수 | 예시 |
|------|------|------|
| 폰트 크기 | `--font-xs` ~ `--font-3xl` | `font-size: var(--font-md);` |
| 간격/패딩 | `--spacing-xs` ~ `--spacing-xl` | `padding: var(--spacing-md);` |
| 버튼 크기 | `--btn-size-sm/md/lg` | `width: var(--btn-size-md);` |
| 아이콘 크기 | `--icon-size-sm/md/lg` | `font-size: var(--icon-size-md);` |
| 모서리 반경 | `--border-radius` | `border-radius: var(--border-radius);` |
| 직접 스케일 | `calc(Npx * var(--ui-scale))` | `width: calc(200px * var(--ui-scale));` |

#### 정의된 CSS 변수

```css
:root {
    --ui-scale: 1;  /* JavaScript에서 동적 조절 (0.6 ~ 1.5) */

    /* 폰트 크기 */
    --font-xs: calc(9px * var(--ui-scale));
    --font-sm: calc(11px * var(--ui-scale));
    --font-md: calc(13px * var(--ui-scale));
    --font-lg: calc(16px * var(--ui-scale));
    --font-xl: calc(20px * var(--ui-scale));
    --font-2xl: calc(24px * var(--ui-scale));
    --font-3xl: calc(32px * var(--ui-scale));

    /* 간격 */
    --spacing-xs: calc(4px * var(--ui-scale));
    --spacing-sm: calc(8px * var(--ui-scale));
    --spacing-md: calc(12px * var(--ui-scale));
    --spacing-lg: calc(16px * var(--ui-scale));
    --spacing-xl: calc(24px * var(--ui-scale));

    /* 버튼/아이콘 크기 */
    --btn-size-sm: calc(32px * var(--ui-scale));
    --btn-size-md: calc(40px * var(--ui-scale));
    --btn-size-lg: calc(50px * var(--ui-scale));
    --icon-size-sm: calc(18px * var(--ui-scale));
    --icon-size-md: calc(24px * var(--ui-scale));
    --icon-size-lg: calc(32px * var(--ui-scale));

    /* 기타 */
    --bar-height: calc(40px * var(--ui-scale));
    --toolbar-height: calc(60px * var(--ui-scale));
    --panel-width: calc(300px * var(--ui-scale));
    --border-radius: calc(6px * var(--ui-scale));
}
```

#### 금지 사항
- ❌ 고정 px 값 직접 사용 금지: `font-size: 14px;`
- ❌ 고정 패딩/마진 금지: `padding: 10px 15px;`
- ✅ CSS 변수 사용 필수: `font-size: var(--font-md);`
- ✅ calc 스케일 사용: `padding: calc(10px * var(--ui-scale));`

---

### 건물 상태 아이콘 시스템

건물 위에 표시되는 상태 아이콘은 **하나만** 표시되며, 우선순위에 따라 가장 중요한 상태만 표시됨.

#### 우선순위 (높은 순)

| 순위 | 상태 | 아이콘 | 설명 |
|------|------|--------|------|
| 1 | 폐건물 | 🏚️ | 건물이 폐건물 상태 |
| 2 | 도로 끊김 (서비스) | 🚫 | 서비스 건물이 도로와 연결 안 됨 |
| 2.5 | 도로 끊김 (민간) | 🚫 | 외곽 도로와 연결 안 됨 |
| 2.8 | 전력 부족 (서비스) | ⚡ | 서비스 건물에 전력 없음 |
| 3 | 전력 부족 | ⚡ | 전력 공급 불가 |
| 4 | 물 부족 | 💧 | 수도 공급 불가 |
| 5 | 소방서 필요 | 🚒 | 소방서 효과 범위 밖 |
| 6 | 경찰서 필요 | 🚔 | 경찰서 효과 범위 밖 |
| 7 | 병원 필요 | 🏥 | 병원 효과 범위 밖 |
| 8 | 학교 필요 | 🏫 | 학교 효과 범위 밖 |
| 9 | 공원 필요 | 🌳 | 공원 효과 범위 밖 |
| 10 | 행복도 낮음 | 😢 | 행복도 30% 미만 |

#### 적용 규칙

1. **아이콘 표시**: 건물당 하나의 아이콘만 표시 (가장 높은 우선순위)
2. **팝업 메시지**: 건물 클릭 시 상태 메시지도 동일한 우선순위 적용
3. **시민 한마디**: 요구사항 메시지가 우선 표시됨

#### 서비스 요구사항 시스템

시민들이 필요로 하는 서비스가 부족할 때 건물에 요구사항 아이콘이 표시됨:

| 서비스 | 효과 범위 | 아이콘 | 시민 메시지 |
|--------|----------|--------|------------|
| 소방서 | 8칸 | 🚒 | "화재가 걱정돼요... 소방서가 필요해요!" |
| 경찰서 | 8칸 | 🚔 | "치안이 불안해요... 경찰서가 필요해요!" |
| 병원 | 12칸 | 🏥 | "아플 때 갈 곳이 없어요... 병원이 필요해요!" |
| 학교 | 10칸 | 🏫 | "아이들 교육이 걱정돼요... 학교가 필요해요!" |
| 공원 | 5칸 | 🌳 | "쉴 곳이 없어요... 공원이 필요해요!" |

#### 요구사항 체크 주기

- **업데이트 주기**: 30초마다 모든 건물의 서비스 요구사항 체크
- **적용 대상**: 민간 건물 (주거/상업, 폐건물 제외)
- **제외 대상**: 서비스 건물, 참조 건물 (2x2의 나머지 3칸)

#### 구현

```javascript
const BUILDING_STATUS = {
    // 치명적 문제 (우선순위 1-4)
    ABANDONED: { priority: 1, icon: '🏚️', message: '폐건물이 되었어요...' },
    SERVICE_NO_ROAD: { priority: 2, icon: '🚫', message: '도로가 끊겨서 운영할 수 없어요!' },
    NO_ROAD: { priority: 2.5, icon: '🚫', message: '도로가 없어서 갈 수가 없어요!' },
    SERVICE_NO_POWER: { priority: 2.8, icon: '⚡', message: '전기가 없어서 운영이 중단됐어요!' },
    NO_POWER: { priority: 3, icon: '⚡', message: '전기가 없어요! 발전소가 필요해요!' },
    NO_WATER: { priority: 4, icon: '💧', message: '수도가 안 나와요! 취수장이 필요해요!' },
    // 서비스 요구사항 (우선순위 5-10)
    NEED_FIRE: { priority: 5, icon: '🚒', message: '화재가 걱정돼요... 소방서가 필요해요!' },
    NEED_POLICE: { priority: 6, icon: '🚔', message: '치안이 불안해요... 경찰서가 필요해요!' },
    NEED_HOSPITAL: { priority: 7, icon: '🏥', message: '아플 때 갈 곳이 없어요... 병원이 필요해요!' },
    NEED_SCHOOL: { priority: 8, icon: '🏫', message: '아이들 교육이 걱정돼요... 학교가 필요해요!' },
    NEED_PARK: { priority: 9, icon: '🌳', message: '쉴 곳이 없어요... 공원이 필요해요!' },
    LOW_HAPPINESS: { priority: 10, icon: '😢', message: '여기 살기 힘들어요...' }
};

// 상태 추가/제거
addBuildingStatus(x, y, 'NO_POWER', building);
removeBuildingStatus(x, y, 'NO_POWER');

// 서비스 요구사항 체크 (30초마다 실행)
function checkBuildingServiceNeeds(x, y, building) {
    // 효과 범위 내 서비스 건물 존재 여부 확인
    // 부족한 서비스는 NEED_* 상태로 추가
}
```

#### 시민 한마디 우선순위

건물 클릭 시 시민 한마디에 표시되는 메시지 우선순위:

1. **요구사항 메시지** (priority <= 4: negative 스타일, 5-10: mid 스타일)
2. **화재 이벤트** (건물이 불타고 있을 때)
3. **공간 부족** (행복도 높은데 자금/공간 부족)
4. **일반 행복도 메시지**

---

### 수치 그래프 시스템

모든 수치 시각화 그래프에는 다음 규칙이 적용됨:

#### 1. 그래프 등장 애니메이션
- **필수**: 모든 수치 그래프는 높이 0에서 원래 높이까지 애니메이션
- **지속 시간**: 500ms (0.5초)
- **이징 함수**: easeOutCubic `(1 - Math.pow(1 - progress, 3))`
- **적용 대상**: 땅값 그래프, 인구 그래프, 향후 추가되는 모든 수치 그래프

```javascript
// 애니메이션 예시
const animationDuration = 500;  // 0.5초
const eased = 1 - Math.pow(1 - progress, 3);  // easeOutCubic
```

#### 2. 수치 모드 진입 시 오브젝트 색상
- **규칙**: 수치 모드 진입 시 모든 오브젝트를 흰색으로 변경
- **목적**: 그래프가 눈에 잘 띄도록 배경 대비 강화
- **적용 대상**: 건물, 도로, 잔디, 수로, 다리 등 모든 3D 오브젝트

#### 3. 좌측 사이드바 수치 버튼
- **위치**: 화면 좌측 사이드바
- **표시 조건**: 구역 모드일 때만 표시
- **버튼 목록**: 땅값 보기, 인구 보기

---

## 인구 시스템

### 건물별 인구 배정

주거 건물에만 인구가 배정되며, 건물 크기에 따라 인구 범위가 결정됨:

| 건물 크기 | 타입 | 인구 범위 |
|----------|------|----------|
| 1x1 | 빌라 | 5-15명 |
| 2x2 | 아파트 | 30-60명 |

### 인구 데이터 특성
- **정적 데이터**: 한 번 배정된 인구는 변하지 않음
- **랜덤 차이**: 같은 크기 건물이어도 인구가 다름 (범위 내 랜덤)
- **저장**: 현재 클라이언트 메모리에만 저장 (DB 연동 예정)

### 연령별 인구 시스템

인구는 4개 연령 그룹으로 나뉘며, 게임 시간 경과에 따라 자연스럽게 변화함.

#### 연령 그룹

| 그룹 | 연령대 | 아이콘 | 노동력 | 세금 기여 |
|------|--------|--------|--------|----------|
| 어린이 | 0-14세 | 👶 | 0% | 0% |
| 청년 | 15-29세 | 🧑 | 80% | 70% |
| 중년 | 30-59세 | 👨 | 100% | 100% |
| 노인 | 60세+ | 👴 | 20% | 50% |

#### 연령 전환 (게임일 기준)

```
어린이 ─(15일)→ 청년 ─(15일)→ 중년 ─(30일)→ 노인 ─(20일 평균수명)→ 사망
```

#### 출생/사망 시스템

| 요소 | 기본값 | 보너스/감소 |
|------|--------|------------|
| 출생률 | 15‰/일 | 학교 +20%, 공원 +10%, 행복도 70+ +20% |
| 사망률 | 8‰/일 | 병원 -30% |

- **출산 가능 인구**: 청년 50% + 중년 30%
- **노인 자연사**: 평균 수명 20일 기준 확률적 사망

#### 서비스 수요 (연령 기반)

각 서비스 시설은 연령별로 다른 수요를 가짐:

| 서비스 | 어린이 | 청년 | 중년 | 노인 |
|--------|--------|------|------|------|
| 🏫 교육 | 100% | 30% | 0% | 0% |
| 🏥 의료 | 30% | 20% | 30% | 100% |
| 🌳 공원 | 80% | 50% | 40% | 70% |

```javascript
// 서비스 수요 계산
서비스 수요 = Σ(연령별 인구 × 연령별 수요율)

// 서비스 커버리지 계산
커버리지(%) = (서비스 건물 수 × 건물당 용량) / 서비스 수요 × 100
```

#### 서비스 용량

| 서비스 | 건물당 용량 |
|--------|------------|
| 학교 | 200명 |
| 병원 | 150명 |
| 공원 | 100명 |

#### UI 표시 (인구 패널)

인구 표시(👥) 클릭 시 표시되는 패널:
- 연령별 인구 막대 그래프 (분홍/파랑/초록/보라)
- 출생률/사망률 (‰ 단위)
- 노동인구 (청년×0.8 + 중년×1.0 + 노인×0.2)
- 서비스 충족률 (80%↑=초록, 50%↑=노랑, 50%↓=빨강)

---

## 공공시설 건설 시스템

### 건설 시 시각 효과

| 효과 | 설명 |
|------|------|
| **차감 금액 표시** | 건물 배치 시 마우스 커서 위치에 `-₩금액` 플로팅 표시 (1.2초간 위로 떠오르며 페이드아웃) |
| **건물 낙하 효과** | 건물이 지면 위 3칸에서 떨어지는 애니메이션 (easeOutCubic, 400ms) |
| **카메라 흔들림** | 건물 착지 시 카메라 상하 흔들림 (intensity: 0.15, duration: 300ms) |

```javascript
// 낙하 애니메이션 이징
const eased = 1 - Math.pow(1 - progress, 3);  // easeOutCubic

// 카메라 흔들림 (사인파 + 감쇠)
const shake = Math.sin(progress * Math.PI * 6) * intensity * decay;
```

### 서비스 효과 물결 이모지

서비스 건물 설치/철거 시 효과 범위 내 민간건물에 이모지가 물결처럼 퍼지며 표시됨:

| 상황 | 이로운 시설 | 나쁜 시설 |
|------|------------|----------|
| **설치 시** | 😊 스마일 | 😢 슬픔 |
| **철거 시** | 😢 슬픔 | 😊 스마일 |

#### 물결 효과 특성
- **전파 방향**: 서비스 건물 중심에서 사방으로 퍼져나감
- **딜레이**: 거리에 비례 (1칸당 50ms)
- **애니메이션**: 건물 위로 떠오르며 페이드아웃 (1.5초)
- **표시 조건**: 화면에 보이는 건물만 표시

```javascript
// 거리 기반 딜레이로 물결 효과 구현
const delay = building.distance * 50;  // 1칸당 50ms

// 3D 좌표 → 2D 화면 좌표 변환
const screenPos = worldPos.project(camera);
```

#### 시설 효과 타입
- **이로운 시설** (기본): 학교, 경찰서, 소방서, 공원
- **나쁜 시설**: `isNegativeEffect: true` 속성 추가 시

### 민간건물 자동 철거

공공시설(서비스 건물) 배치 시 해당 위치에 민간건물(주거/상업)이 있으면 자동 철거:

- **적용 대상**: 주거 구역 건물, 상업 구역 건물
- **철거 대상 아님**: 도로, 수로, 다리, 기존 공공시설
- **동작**: 2x2 건물 배치 시 해당 영역의 모든 민간건물 자동 철거 후 건설

### 공공시설 배치 규칙

| 규칙 | 설명 |
|------|------|
| **도로 인접 필수** | 건물의 타일 중 하나라도 도로에 인접해야 배치 가능 |
| **잔디 타일 대체** | 공공시설은 잔디 타일 위에 건설됨 (구역과 동일) |
| **구역 지정 차단** | 공공시설이 있는 타일에는 구역(주거/상업) 지정 불가 |
| **도로 설치 차단** | 공공시설이 있는 타일에는 도로 설치 불가 |

### 건설 서브메뉴 시스템

모든 건설 버튼은 하위 타입 선택을 위한 서브메뉴를 제공:

| 건물 카테고리 | 서브메뉴 항목 | 비용 | 크기 |
|--------------|-------------|------|------|
| **🚒 소방서** | 동네 소방서 | ₩3,000 | 2x2 |
|              | 대형 소방서 (미구현) | ₩8,000 | 3x3 |
| **🚔 경찰서** | 소형 경찰서 | ₩3,000 | 2x2 |
|              | 대형 경찰서 (미구현) | ₩8,000 | 3x3 |
| **🏫 학교**  | 초등학교 | ₩4,000 | 2x2 |
|              | 고등학교 (미구현) | ₩10,000 | 3x3 |
| **🌳 공원**  | 소형 공원 | ₩1,000 | 2x2 |
|              | 대형 공원 (미구현) | ₩5,000 | 3x3 |

#### 서브메뉴 구현 규칙

```javascript
// SUBMENU_CONFIG에 카테고리별 항목 정의
const SUBMENU_CONFIG = {
    fire: {
        title: '🚒 소방서',
        items: [
            { id: 'fire_small', icon: '🚒', cost: 3000, name: '동네 소방서', size: '2x2' },
            { id: 'fire_large', icon: '🏢', cost: 8000, name: '대형 소방서', size: '3x3' },
        ]
    },
    // ... 기타 카테고리
};
```

- **버튼 클릭**: `openSubMenu(type)` 호출로 서브메뉴 열기
- **항목 클릭**: `handleSubmenuClick(type, itemId)` 호출로 모드 설정
- **미구현 항목**: 토스트 메시지 표시 후 서브메뉴 유지

### 소방서 클릭 팝업

소방서를 클릭하면 소방차 현황을 막대그래프로 표시:

| 정보 | 설명 |
|------|------|
| **출동 중** | 화재 진압/복귀 중인 소방차 수 (빨간색 바) |
| **대기 중** | 출동 가능한 소방차 수 (초록색 바) |
| **총 보유** | 해당 소방서의 총 소방차 / 최대 대수 |

- **최대 소방차**: 소방서당 2대
- **업데이트 주기**: 0.5초마다 갱신

---

## 예산 시스템 (SimCity 5 스타일)

### 수익 계산 공식

```
시간당 수익 = 세금 수입 - 서비스 운영비

세금 수입 = Σ(건물 레벨 × 시민 수 × 세금율)
서비스 운영비 = Σ(서비스 건물별 운영비)
```

### 세금 시스템

#### 계층별 세금율

| 계층 | 기본 세금율 | 조절 범위 | 인당 기본 세금 |
|------|-----------|----------|--------------|
| 하류층 | 10% | 0-20% | ₩10/시간 |
| 중류층 | 10% | 0-20% | ₩30/시간 |
| 상류층 | 10% | 0-20% | ₩80/시간 |
| 상업 | 10% | 0-20% | ₩20/시간 |
| 공업 | 10% | 0-20% | ₩15/시간 |

#### 세금 계산 예시

```javascript
// 레벨 2 주거 건물, 시민 50명, 세금율 10%
세금 = 레벨(2) × 시민수(50) × 기본세금(₩10) × 세금율(0.1)
     = 2 × 50 × 10 × 0.1 = ₩100/시간
```

### 서비스 건물 운영비

| 시설 | 건설비 | 시간당 운영비 | 설명 |
|------|--------|-------------|------|
| 소방서 | ₩3,000 | ₩50/시간 | 화재 예방 및 진압 |
| 경찰서 | ₩3,000 | ₩60/시간 | 치안 유지 |
| 학교 | ₩4,000 | ₩80/시간 | 교육 서비스 |
| 공원 | ₩1,000 | ₩20/시간 | 시민 행복도 증가 |
| 병원 | ₩6,000 | ₩100/시간 | 의료 서비스 |

### 서브메뉴 툴팁

서비스 건물 선택 시 마우스 호버하면 상세 정보 표시:

```
┌─────────────────────────┐
│ 🚒 동네 소방서          │
│ 건설비: ₩3,000         │
│ 운영비: ₩50/시간       │
│ 효과 범위: 8칸         │
│ "화재 예방 및 신속 대응" │
└─────────────────────────┘
```

### 하단 바 정보 표시

| 표시 항목 | 형식 | 설명 |
|----------|------|------|
| 현재 자금 | ₩1,234,567 | 현재 보유 자금 |
| 시간당 수익 | +₩500/h 또는 -₩200/h | 수입-지출 (양수: 초록, 음수: 빨강) |
| 예산 버튼 | 📊 | 클릭 시 예산 패널 열기 |

### 예산 패널 UI

SimCity 5 스타일의 예산 관리 패널:

```
┌─────────────────────────────────────────────────┐
│ 📊 시 예산                              [닫기] │
├─────────────────────────────────────────────────┤
│                                                 │
│  ◀ 지출                        수입 ▶          │
│  ────────────────────┼────────────────────      │
│  🏠 주거 세금     ██████████████  ₩12,000  10% │
│  🏪 상업 세금     ████████        ₩4,000   10% │
│  🏭 공업 세금     ██████          ₩3,000   10% │
│  ────────────────────────────────────────────── │
│  🚒 소방서    ████               -₩300         │
│  🚔 경찰서    ██████             -₩480         │
│  🏫 학교      ████████           -₩640         │
│  🌳 공원      ██                 -₩100         │
│  ────────────────────────────────────────────── │
│  📈 중간 합계:  지출 -₩1,520  |  수입 +₩19,000 │
│  💰 시간당 순이익: +₩17,480                     │
├─────────────────────────────────────────────────┤
│  💳 채권                                        │
│  ┌─────────┬─────────┬─────────┐               │
│  │ 채권 A  │ 채권 B  │ 채권 C  │               │
│  │ ₩10,000 │ ₩50,000 │₩100,000 │               │
│  │ 이자 5% │ 이자 7% │ 이자 10%│               │
│  └─────────┴─────────┴─────────┘               │
│  현재 부채: ₩0                                  │
├─────────────────────────────────────────────────┤
│  📋 최근 거래                                   │
│  ├ 세금 수집      +₩12,003                     │
│  ├ 소방서 건설    -₩3,000                      │
│  └ 채권 A 발행    +₩10,000                     │
├─────────────────────────────────────────────────┤
│  💵 총 자산: ₩40,166,078                       │
└─────────────────────────────────────────────────┘
```

### 채권 시스템

은행에서 자금을 빌리는 시스템:

| 채권 | 대출 금액 | 이자율 | 상환 기간 | 시간당 이자 |
|------|----------|-------|----------|------------|
| 채권 A | ₩10,000 | 5% | 10시간 | ₩50/시간 |
| 채권 B | ₩50,000 | 7% | 10시간 | ₩350/시간 |
| 채권 C | ₩100,000 | 10% | 10시간 | ₩1,000/시간 |

- **발행**: 즉시 자금 획득
- **상환**: 시간당 이자 자동 차감
- **최대 발행**: 채권당 1개씩만 발행 가능
- **조기 상환**: 남은 원금 일시 상환 가능

---

## 땅값 시스템

### 땅값 구성

땅값은 기본값, 서비스 보너스, 폐건물 페널티의 합으로 계산됨:

```
총 땅값 = 기본 땅값 + 서비스 시설 보너스 - 폐건물 페널티
```

### 서비스 시설 보너스

각 공공시설은 효과 범위 내 건물에 땅값 보너스를 제공:

| 시설 | 효과 범위 | 땅값 보너스 |
|------|----------|------------|
| 학교 | 10칸 | +150 |
| 경찰서 | 8칸 | +100 |
| 소방서 | 8칸 | +100 |
| 공원 | 5칸 | +80 |

- **거리 감쇠**: `falloff = 1 - (거리 / 효과범위)` - 시설 중심에서 멀어질수록 보너스 감소
- **중첩 가능**: 여러 시설의 효과 범위가 겹치면 보너스 합산

### 폐건물 페널티

폐건물은 주변 땅값을 하락시키는 부정적 오라를 발생:

| 설정 | 값 |
|------|-----|
| 효과 범위 | 4칸 |
| 최대 땅값 감소 | -50 |

- **폐건물 자체**: 서비스 시설 버프/너프를 받지 못함
- **주변 건물**: 거리에 따라 감소하는 땅값 페널티 적용
- **행복도**: 폐건물은 행복도에 직접적인 영향 없음 (땅값 통해 간접 영향)

### 행복도 연동

- **행복도 = 총 땅값** (기본값 + 서비스 보너스 - 폐건물 페널티)
- 서비스 시설 배치로 땅값 증가 → 행복도 자동 상승
- 폐건물 방치 시 주변 땅값 하락 → 행복도 간접 하락

### 땅값 시각화

- **건물 팝업**: 기본 땅값(파란색)과 보너스(초록색) 막대그래프 + 화살표 인디케이터
- **구역 모드 땅값 그래프**: 총 땅값(기본+보너스-페널티) 기준으로 3D 막대 높이 표시

---

## 폐건물 시스템

### 폐건물 발생 조건

| 원인 | 설명 |
|------|------|
| 낮은 행복도 | 60초간 행복도 < 30% 유지 시 폐건물화 |
| 화재 전소 | 소방차 미출동 시 건물 전소 → 폐건물 |

### 폐건물 특성

| 특성 | 설명 |
|------|------|
| **버프 불가** | 서비스 시설의 땅값 보너스를 받지 못함 |
| **너프 불가** | 부정적 효과 시설의 영향도 받지 않음 |
| **땅값 하락 오라** | 주변 4칸 범위에 땅값 -50 페널티 발생 |
| **행복도 무영향** | 폐건물 자체는 행복도에 직접 영향 없음 |
| **복구 불가** | 철거만 가능, 자동 복구 없음 |
| **세금 없음** | 폐건물은 세금을 납부하지 않음 |

### 폐건물 시각화

- **아이콘**: 건물 위에 🏚️ 아이콘 표시 (바운스 애니메이션)
- **텍스처**: 어두운 회색 단색으로 변경
- **팝업**: "폐건물" 표시 + 빨간색 상태 배지

---

## 데이터 뷰 범례 시스템

### 범례 패널 규칙

모든 데이터 시각화 모드(땅값, 인구, 교통량 등)에는 좌측 상단에 범례 패널이 표시됨:

| 항목 | 설명 |
|------|------|
| **헤더** | 아이콘 + 모드명 + 닫기 버튼 |
| **통계** | 해당 모드의 평균/총합 수치 |
| **범례** | 색상 그라데이션 바 + 낮음/높음 라벨 |
| **토글** | 지형/건물 색상 표시 체크박스 |

### 모드별 범례 내용

| 모드 | 아이콘 | 통계 | 그라데이션 |
|------|--------|------|------------|
| 땅값 | 💰 | 평균 땅값 (₩/칸) | 파랑→초록→주황 |
| 인구 | 👥 | 총 인구 (명) | 회색→파랑→보라 |
| 교통량 | 🚗 | 평균 교통량 (%) | 초록→노랑→빨강 |

### 모드 계층 구조

```
구역 모드 (Zone Mode)
├── 땅값 보기 (Land Value View)
├── 인구 보기 (Population View)
└── 구역 지정 모드 종료 시 → 하위 뷰 자동 종료

도로 모드 (Road Mode)
└── 교통량 보기 (Traffic View)
    └── 도로 모드 종료 시 → 교통량 뷰 자동 종료
```

### 중요 규칙

1. **범례 자동 표시**: 데이터 뷰 진입 시 범례 패널 자동 표시
2. **범례 자동 숨김**: 데이터 뷰 종료 시 범례 패널 자동 숨김
3. **상위 모드 종료**: 상위 모드(구역/도로) 종료 시 하위 데이터 뷰도 함께 종료
4. **닫기 버튼**: 범례 닫기 버튼 클릭 시 해당 데이터 뷰 종료

---

## 개발자 테스트 패널

### 개요

화면 우측 상단에 위치한 통합 디버그 패널. 게임 시스템 테스트 및 디버깅을 위한 도구 모음.

### 패널 기능

| 섹션 | 기능 |
|------|------|
| **Traffic System** | 차량 수, 도로 노드, 신호등, 건물 수, 경로 캐시 정보 표시 |
| **Fire System** | 활성 화재 수, 출동 중인 소방차 수 표시 |
| **Time Control** | 게임 내 시간 조절 (낮/밤/일출/일몰 버튼 + 슬라이더) |
| **Selected Building** | 선택된 건물의 위치, 타입, 상태 정보 표시 |

### 화재 시스템 컨트롤

| 버튼 | 기능 |
|------|------|
| **🔥 선택 건물 화재** | 현재 선택된 건물에 화재 발생 |
| **💧 전체 진압** | 모든 활성 화재 즉시 진압 |

### 사용 방법

1. **건물 선택**: 카메라 모드에서 건물 클릭
2. **화재 발생**: "선택 건물 화재" 버튼 클릭
3. **화재 관찰**: 소방차 출동 및 화재 진행 확인
4. **전체 진압**: 필요시 "전체 진압" 버튼으로 모든 화재 제거

### 패널 조작

- **드래그**: 헤더 영역을 드래그하여 위치 이동
- **접기/펼치기**: 우측 상단 `−`/`+` 버튼 클릭

### 시간 컨트롤 버튼

| 버튼 | 시간 |
|------|------|
| 🌅 | 06:00 (일출) |
| ☀️ | 12:00 (낮) |
| 🌇 | 18:30 (일몰) |
| 🌙 | 22:00 (밤) |

---

## 화재 시스템

### 화재 발생 로직

```javascript
const FIRE_CHECK_INTERVAL = 5000;      // 5초마다 화재 체크
const FIRE_BASE_CHANCE = 0.005;        // 기본 발생 확률 0.5%
const FIRE_INDUSTRIAL_MULTIPLIER = 3;  // 공업 지역 3배
const FIRE_BURNOUT_TIME = 30000;       // 30초 후 전소
```

### 화재 효과

| 효과 | 설명 |
|------|------|
| **불꽃** | Points 기반 파티클, 위로 상승하며 깜빡임 |
| **연기** | Sprite 기반 4프레임 텍스처 애니메이션 |

### 연기 텍스처

- **파일**: `/textures/msVFX_Stylized Smoke 1_Texture.png`
- **크기**: 1024x256 (256x256 x 4 프레임)
- **사용**: UV 오프셋으로 4개 프레임 중 랜덤 선택

### 소방차 출동

| 단계 | 동작 |
|------|------|
| 1 | 가장 가까운 소방서 탐색 |
| 2 | 소방차 생성 및 경로 계산 (A* 알고리즘) |
| 3 | 화재 현장으로 이동 (속도 1.5배) |
| 4 | 도착 시 즉시 진화, 미도착 시 건물 전소 |

### 전소된 건물

- **외관**: 회색 (0x333333) 텍스처 적용
- **상태**: `isAbandoned: true`
- **표시**: 폐건물 아이콘 표시

---

## 건설 하위 메뉴 시스템

### 개요

하단 툴바의 건설 버튼 클릭 시 하위 메뉴가 표시되어 여러 타입의 건물을 선택할 수 있음. 도로/수로 토글 시스템과 동일한 방식으로 구현.

### 하위 메뉴 구조

#### 도로/수로 (🛣️)
| 항목 | 아이콘 | 설명 | 상태 |
|------|--------|------|------|
| 2차로 | 🛤️ | 기본 도로 | ✅ 구현 |
| 4차로 | 🛣️ | 대로 | ⏳ 미구현 |
| 수로 | 🌊 | 수로 설치 | ✅ 구현 |

#### 소방서 (🚒)
| 항목 | 아이콘 | 비용 | 크기 | 상태 |
|------|--------|------|------|------|
| 동네 소방서 | 🚒 | ₩3,000 | 2x2 | ✅ 구현 |
| 대형 소방서 | 🏢 | ₩8,000 | 3x3 | ⏳ 미구현 |

#### 경찰서 (🚔)
| 항목 | 아이콘 | 비용 | 크기 | 상태 |
|------|--------|------|------|------|
| 소형 경찰서 | 🚔 | ₩3,000 | 2x2 | ✅ 구현 |
| 대형 경찰서 | 🏛️ | ₩8,000 | 3x3 | ⏳ 미구현 |

### 구현 방식

```javascript
// SUBMENU_CONFIG에 메뉴 정의
const SUBMENU_CONFIG = {
    fire: {
        title: '🚒 소방서',
        items: [
            { id: 'fire_small', icon: '🚒', cost: 3000, name: '동네 소방서', size: '2x2' },
            { id: 'fire_large', icon: '🏢', cost: 8000, name: '대형 소방서', size: '3x3' },
        ]
    },
    // ...
};

// 버튼 클릭 시 서브메뉴 열기
btnFire.addEventListener("click", () => {
    if (isFireModeActive) {
        closeSubMenu();
        setMode(MODE.CAMERA);
    } else {
        openSubMenu('fire');
    }
});

// 서브메뉴 항목 클릭 처리
handleSubmenuClick('fire', 'fire_small');  // → setMode(MODE.PLACE_FIRE)
handleSubmenuClick('fire', 'fire_large');  // → "미구현" 토스트
```

### 토글 동작

1. **첫 클릭**: 서브메뉴 열림 (건물 타입 선택)
2. **항목 선택**: 해당 건설 모드 진입, 서브메뉴 닫힘
3. **미구현 항목**: "미구현" 토스트 표시, 서브메뉴 유지
4. **다시 클릭** (이미 활성화 상태): 카메라 모드로 복귀

### 향후 확장

새 건물 타입 추가 시:
1. `SUBMENU_CONFIG`에 항목 추가
2. `handleSubmenuClick`에 처리 로직 추가
3. 필요시 새 `MODE` 상수 정의

---

## 교통 시스템

### 차량 길이 기반 안전거리 계산

각 차량 종류별 길이가 정의되어 있으며, 앞차와의 안전거리 계산 시 양 차량의 길이를 고려:

| 차량 종류 | 길이 (타일 단위) |
|----------|-----------------|
| 스포츠카 | 0.22 |
| 승용차/택시/세단 | 0.25 |
| 경찰차 | 0.28 |
| SUV | 0.30 |
| 구급차 | 0.35 |
| 견인차 | 0.38 |
| 트럭/캠핑카 | 0.40 |
| 스쿨버스/소방차 | 0.45 |
| 시내버스 | 0.50 |

#### 안전거리 계산 공식

```javascript
// 실제 간격 = 중심간 거리 - (내 차량 길이/2) - (앞차 길이/2)
const actualGap = centerDist - (myLength / 2) - (otherLength / 2);
```

- **긴 차량 뒤**: 더 먼 거리에서 감속 시작
- **짧은 차량 뒤**: 더 가까이 접근 가능
- **검색 범위**: 1.5 타일 (긴 차량 고려하여 확장)

---

## 행복도 시스템

### 행복도 계산 공식

```javascript
행복도 = 30 + (총 땅값 × 0.5) - RCI부족 페널티 - 세금 페널티
```

| 요소 | 영향 |
|------|------|
| 기본값 | 30 |
| 땅값 보너스 | 땅값 × 0.5 |
| RCI 부족 | 부족 시 페널티 |
| 세금 페널티 | (평균 세금율 - 10%) × 2 |

### 세금과 행복도

```javascript
// 기본 세금율 10%에서 페널티 없음
// 10% 초과분에 대해 2배의 페널티 적용
const taxPenalty = Math.max(0, (avgTaxRate - 10) * 2);
```

| 평균 세금율 | 행복도 페널티 |
|------------|--------------|
| 10% | 0 |
| 12% | -4 |
| 15% | -10 |
| 20% | -20 |

### 행복도 색상 (그라데이션)

```javascript
// 0 = 빨강(#f87171), 50 = 노랑(#fbbf24), 100 = 초록(#4ade80)
function getHappinessColor(happiness) {
    // 0~50: 빨강 → 노랑
    // 50~100: 노랑 → 초록
}
```

---

## 이벤트 시스템 (시민 한마디)

### 이벤트 발생 건물 표시

건물에 이벤트(화재 등)가 발생하면 시민 한마디에 이벤트 관련 문구가 표시됨:

| 이벤트 | 표시 문구 (예시) |
|--------|-----------------|
| 화재 | "🔥 불이야! 소방차가 필요해요!" |
|      | "🔥 도와주세요! 집에 불이 났어요!" |
|      | "🔥 빨리 대피해야 해요!" |

#### 표시 우선순위

1. **이벤트 발생 중** → 이벤트 관련 문구 (citizen-quote mid 스타일)
2. **정상 상태** → 행복도 기반 시민 한마디

```javascript
if (isBurning) {
    // 화재 이벤트 문구 표시
    citizenQuote.className = 'citizen-quote mid';
} else {
    // 일반 시민 한마디 (행복도 기반)
}
```

---

## 시 예산 패널

### 총 자산 계산

```javascript
총 자산 = 현재 보유 자금 - 채권 부채
```

| 상태 | 표시 |
|------|------|
| 자산 > 0 | 녹색 (+₩금액) |
| 자산 < 0 | 빨간색 (-₩금액) |

### 실시간 업데이트

- 자금 변동 시 예산 패널이 열려있으면 총 자산 자동 갱신
- 채권 발행/상환 시 즉시 반영

---

## 시민 SNS 피드 시스템

### 개요

화면 우측에 위치한 시티즈 스카이라인 스타일의 시민 SNS 피드. 게임 내 이벤트에 따라 시민들이 유쾌하고 비꼬는 댓글을 남김.

### 위치 및 UI

| 항목 | 설명 |
|------|------|
| 위치 | 화면 우측 상단 (top: 50px, right: 12px) |
| 크기 | 280px 너비, 최대 400px 높이 |
| 스타일 | 다크 테마, 반투명 배경, 블러 효과 |

### 이벤트 기반 시스템

**중요**: SNS 피드는 랜덤/일반 포스트 없이 **오직 게임 내 실제 이벤트에만** 반응하여 포스트를 생성함.

### 이벤트별 댓글

#### 부정적 이벤트 (빨간색 테두리)
| 이벤트 | 이벤트ID | 댓글 예시 |
|--------|----------|----------|
| 전기 없음 | noPower | "전기가 없어서 살 수가 없어요 완전 원시시대 같네요 🕯️" |
| 물 없음 | noWater | "화장실 물이 안 내려가요... 더 이상의 자세한 설명은 생략 🚽" |
| 화재 발생 | fireStart | "불이야!!! 🔥🔥🔥 빨리 와주세요!!!" |
| 건물 전소 | fireBurnout | "집이 다 탔어요... 소방차는 어디 있었던 거예요 😭" |
| 치안 실패 | crimeFailed | "이 도시는 치안이란게 없나요? 범죄자가 활개치고 다녀요 😠" |
| 환경 오염 | pollutionHigh | "공기가 안 좋아요... 마스크 필수 😷" |

#### 경고 이벤트 (노란색 테두리)
| 이벤트 | 이벤트ID | 댓글 예시 |
|--------|----------|----------|
| 소방서 부족 | noFireStation | "소방서가 너무 멀어요... 화재나면 어쩌죠? 🔥" |
| 경찰서 부족 | noPolice | "밤에 무서워서 못 다니겠어요... 경찰서 좀 지어주세요 👮" |
| 병원 부족 | noHospital | "응급실 가려면 30분 운전해야 해요 😰" |
| 교통 체증 | trafficJam | "출퇴근 시간 도로가 꽉 막혀요... 🚗🚗🚗" |

#### 긍정적 이벤트 (초록색 테두리)
| 이벤트 | 이벤트ID | 댓글 예시 |
|--------|----------|----------|
| 전기 복구 | powerRestored | "드디어 에어컨! 시장님 사랑해요 ❤️" |
| 화재 진압 | fireExtinguished | "소방관 아저씨들 최고예요!!! 🚒💕" |
| 범죄 체포 | crimeHandled | "경찰이 강도를 잡았대요! 아주 든든해요 💪👮" |
| 소방서 건설 | fireStationBuilt | "소방서 생겼다! 이제 안심이에요 🚒" |
| 경찰서 건설 | policeHelp | "경찰서 생기고 마음이 편해졌어요 😊" |
| 학교 건설 | schoolBuilt | "학교 생겼다! 우리 애 걸어서 통학 가능! 🏫" |
| 공원 건설 | parkBuilt | "공원 생겼다! 오늘부터 매일 조깅이다 🏃‍♂️" |
| 인구 증가 | populationGrowth | "새 이웃이 이사왔어요! 환영합니다~ 🏠" |

### 기능

| 기능 | 설명 |
|------|------|
| 접기/펼치기 | 헤더 클릭으로 패널 접기/펼치기 |
| 읽지 않은 개수 | 접혀있을 때 새 포스트 개수 배지 표시 |
| 이벤트 기반 | 게임 이벤트 발생 시에만 포스트 생성 (랜덤 포스트 없음) |
| 최대 포스트 | 최대 15개 유지 (FIFO) |

### 구현

```javascript
// SNS 이벤트 트리거 (게임 내 이벤트 발생 시 호출)
CitizenSNS.onEvent('fireStart', '(x, y) 근처');      // 화재 발생
CitizenSNS.onEvent('fireExtinguished', '위치');       // 화재 진압
CitizenSNS.onEvent('crimeHandled', '위치');           // 범죄 체포 성공
CitizenSNS.onEvent('crimeFailed', '위치');            // 범죄 체포 실패
CitizenSNS.onEvent('fireStationBuilt', '위치');       // 소방서 건설
CitizenSNS.onEvent('noPower', '위치');                // 전기 없음
CitizenSNS.onEvent('powerRestored', '위치');          // 전기 복구
```

### 연결된 게임 이벤트

| 게임 시스템 | 트리거 위치 | SNS 이벤트 |
|------------|------------|-----------|
| 화재 시스템 | `startFire()` | fireStart |
| 화재 시스템 | `extinguishFire()` | fireExtinguished |
| 화재 시스템 | 건물 전소 시 | fireBurnout |
| 범죄 시스템 | `resolveCrime(byPolice=true)` | crimeHandled |
| 범죄 시스템 | `applyCrimeDamage()` | crimeFailed |
| 건설 시스템 | 공공시설 배치 시 | fireStationBuilt, policeHelp 등 |

### 포스트 구조

```javascript
{
    id: Date.now(),           // 고유 ID
    name: '김민준',           // 랜덤 생성된 시민 이름
    avatar: '👨',             // 랜덤 아바타 이모지
    message: '댓글 내용...',  // 이벤트별 랜덤 메시지
    type: 'positive',         // positive, negative, warning, info
    location: '중앙구 아파트', // 랜덤 위치
    time: new Date(),         // 작성 시간
    likes: 23,                // 랜덤 좋아요 수
    comments: 5               // 랜덤 댓글 수
}
```

---

## 건물 상태 아이콘 위치 계산

건물 위에 표시되는 상태 아이콘(⚡, 💧, 🚫 등)의 위치는 3D 바운딩 박스를 사용하여 계산됨.

### 구현 방식

```javascript
// 바운딩 박스로 건물 상단 위치 계산
_iconBox.setFromObject(building.instance);  // 3D 모델 전체 범위
_iconBox.getCenter(_iconCenter);             // 중앙 좌표

// 건물 상단 중앙에 아이콘 위치
_iconTop.set(_iconCenter.x, _iconBox.max.y + 0.5, _iconCenter.z);

// 3D → 2D 화면 좌표 변환 (GPU 가속)
_iconTop.project(camera);
const x = (_iconTop.x * 0.5 + 0.5) * clientW;
const y = (-_iconTop.y * 0.5 + 0.5) * clientH;

// CSS transform으로 GPU 가속 적용
element.style.transform = `translate3d(${x - hw}px, ${y - hh}px, 0)`;
```

### 최적화

| 항목 | 설명 |
|------|------|
| 재사용 객체 | `_iconBox`, `_iconCenter`, `_iconTop` 등 Vector3/Box3 재사용 |
| GPU 가속 | `translate3d()` 사용으로 리플로우 방지 |
| 조건부 업데이트 | 카메라 이동 시에만 위치 업데이트 |

---

## 뷰 모드 머티리얼 관리

### 수도/하수 뷰 전환 시 머티리얼 캐시 문제

수도(Water)와 하수(Sewage) 뷰 모드는 `oceanSewageSystem`을 공유하여 바다 오염 시각화를 표시함. 뷰 모드 간 직접 전환 시 머티리얼 캐시가 꼬일 수 있음.

### 문제 원인

1. 수도 뷰 진입: `waterManager`가 회색 머티리얼 적용
2. `oceanSewageSystem.toggleView(true)`: 이미 회색인 머티리얼을 "원본"으로 저장
3. 하수 뷰로 전환: `waterManager` 복원, 하지만 `oceanSewageSystem`은 회색을 원본으로 기억
4. 카메라 모드 복귀: `oceanSewageSystem`이 회색 머티리얼로 "복원" → 버그!

### 해결 방법

#### 1. 뷰 진입 순서 변경

`oceanSewageSystem.toggleView(true)`를 `setMode()` 호출 전에 실행하여 원본 머티리얼을 먼저 저장:

```javascript
// 바다 하수 시각화 (setMode 전에 원본 머티리얼 저장)
if (typeof oceanSewageSystem !== 'undefined') {
    oceanSewageSystem.toggleView(true);  // 원본 저장
}
setMode(MODE.WATER_VIEW);  // 이후 회색 적용
```

#### 2. 뷰 간 전환 시 캐시 갱신

수도 ↔ 하수 직접 전환 시 `oceanSewageSystem` 머티리얼 캐시를 강제 갱신:

```javascript
// 수도 → 하수 전환 시 머티리얼 캐시 갱신
if (sewageRelatedModes.includes(mode)) {
    if (oceanSewageSystem.isViewActive) {
        oceanSewageSystem.originalMaterials.clear();
        oceanSewageSystem.applyDataViewMaterials(true);
    }
}
```

### 관련 컴포넌트

| 컴포넌트 | 머티리얼 저장소 | 역할 |
|----------|---------------|------|
| `waterManager` | `waterViewOriginalMaterials` | 수도 뷰 회색 머티리얼 |
| `oceanSewageSystem` | `originalMaterials` | 바다 오염 시각화 머티리얼 |
| `powerManager` | `powerViewOriginalMaterials` | 전력 뷰 머티리얼 |

---

## 시각화 오버레이 렌더링 (Always-On-Top)

### 개요

데이터 시각화 그래프(땅값, 인구, 교통량 등)와 유틸리티 연결선(전력선, 수도관, 하수관)은 다른 오브젝트에 가려지지 않고 항상 최상단에 렌더링됨. Unity의 레이어 시스템과 유사한 방식.

### 구현 방법

#### 1. renderOrder 설정

Three.js의 `renderOrder` 속성으로 렌더링 순서를 제어:

```javascript
// 시각화 그래프 그룹
landValueGroup.renderOrder = 999;
populationGroup.renderOrder = 999;
trafficViewGroup.renderOrder = 999;
windViewGroup.renderOrder = 999;

// 유틸리티 연결선
powerManager.powerLineGroup.renderOrder = 999;
powerManager.powerIconGroup.renderOrder = 1000;  // 선보다 위에

waterManager.waterPipeGroup.renderOrder = 999;
waterManager.waterIconGroup.renderOrder = 1000;

sewageManager.sewagePipeGroup.renderOrder = 999;
sewageManager.sewageIconGroup.renderOrder = 1000;
```

#### 2. 깊이 테스트 비활성화 (유틸리티 연결선)

전력선/수도관/하수관은 건물 뒤에 가려도 항상 보이도록 깊이 테스트 비활성화:

```javascript
const lineMaterial = new THREE.MeshBasicMaterial({
    color: 0xffcc00,
    transparent: true,
    opacity: 0.95,
    depthTest: false,   // 깊이 테스트 비활성화 (항상 렌더링)
    depthWrite: false   // 깊이 버퍼에 쓰지 않음
});
```

### 적용 대상

| 대상 | renderOrder | depthTest | 설명 |
|------|-------------|-----------|------|
| 땅값 그래프 | 999 | true | 건물 위에 렌더링 |
| 인구 그래프 | 999 | true | 건물 위에 렌더링 |
| 교통량 그래프 | 999 | true | 도로 위에 렌더링 |
| 바람 시각화 | 999 | true | 지형 위에 렌더링 |
| 전력선 | 999 | false | 항상 보임 |
| 수도관 | 999 | false | 항상 보임 |
| 하수관 | 999 | false | 항상 보임 |
| 유틸리티 아이콘 | 1000 | false | 연결선보다 위에 |

### 주의사항

- `depthTest: false` 사용 시 렌더링 순서가 중요해짐
- 동일 `renderOrder` 내에서는 추가 순서대로 렌더링됨
- 아이콘은 연결선보다 높은 `renderOrder`로 항상 위에 표시
